<% layout("/layout/boilerplate.ejs") -%>

  <main class="max-w-[1440px] mx-auto grid grid-cols-1 md:grid-cols-12 gap-4 md:gap-6 p-3 md:p-8 pb-24 md:pb-8">
    <!-- Left Sidebar: Utility Column (Hidden on Mobile) -->
    <aside class="hidden md:block md:col-span-3 space-y-6 h-fit sticky top-24">
      <div class="glass-card rounded-xl p-5 flex flex-col gap-4">
        <div>
          <h1 class="text-white text-lg font-bold">Utility</h1>
          <p class="text-white/50 text-xs">Manage your campus life</p>
        </div>
        <nav class="space-y-2">
          <a href="/home"
            class="w-full flex items-center gap-3 px-4 py-3 rounded-xl bg-primary text-white shadow-lg shadow-primary/20 transition-transform active:scale-95">
            <span class="material-symbols-outlined fill">amp_stories</span>
            <span class="text-sm font-semibold">Feed</span>
          </a>
          <a href="/user/sync-requests"
            class="w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-white/5 text-white/80 transition-colors">
            <span class="material-symbols-outlined">person_add</span>
            <span class="text-sm font-medium">Connection Requests</span>
            <% if (connectionRequestCount> 0) { %>
              <span class="ml-auto bg-primary text-[10px] px-2 py-0.5 rounded-full animate-pulse">
                <%= connectionRequestCount %>
              </span>
              <% } %>
          </a>
          <button
            class="w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-white/5 text-white/80 transition-colors">
            <span class="material-symbols-outlined">help_center</span>
            <a href="/doubtBin" class="text-sm font-medium">DoubtBin</a>
          </button>
        </nav>
      </div>

      <!-- DoubtBin Widget -->
      <% if(currentUser.doubt.length> 0) { %>
        <div class="glass-card rounded-xl p-5">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-sm font-bold text-white uppercase tracking-wider">
             Your Recent Doubt
            </h3>
            <span class="material-symbols-outlined text-primary text-sm">trending_up</span>
          </div>
          <div class="space-y-4">
            <% for (let Doubt of currentUser.doubt) { %>
              <div class="border-l-2 border-primary pl-3">
                <a href="/doubtBin/<%=Doubt._id%>" class="text-xs text-white/90 font-medium line-clamp-2">
                  <%=Doubt.title%>
                </a>
                <p class="text-[10px] text-white/40 mt-1">
                  <%=Doubt.answers.length%> Answers • <%=Doubt.createdAt.toDateString()%>
                </p>
              </div>
              <% } %>
          </div>
        </div>
        <% } else{ %>
          <div class="glass-card rounded-2xl p-5">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-sm font-bold text-white uppercase tracking-wider">DoubtBin</h3>
              <span class="material-symbols-outlined text-primary text-sm">help_outline</span>
            </div>
            <div class="flex flex-col items-center justify-center py-3 text-center space-y-4">
              <div class="size-16 rounded-full bg-white/5 flex items-center justify-center">
                <span class="material-symbols-outlined text-white/20 text-3xl">help_outline</span>
              </div>
              <div>
                <p class="text-sm text-white/80 font-medium">Stuck somewhere?</p>
                <p class="text-xs text-white/40">Ask your 1st doubt!</p>
              </div>
              <a href="/doubtBin/ask-doubt"
                class="w-full py-2.5 bg-primary rounded-xl text-white text-sm font-bold shadow-lg shadow-primary/20 hover:brightness-110 transition-all">
                Ask Doubt
              </a>
            </div>
          </div>
          <% } %>
    </aside>

    <!-- Center Feed: Social Cards -->
    <% if(view==="feed" ) { %>
      <section class="col-span-1 md:col-span-6 space-y-4 md:space-y-6">
        <!-- Post Composer Placeholder -->
        <div class="glass-card rounded-xl p-3 md:p-4 flex gap-3 md:gap-4 items-center">
          <div class="size-9 md:size-10 rounded-full bg-cover bg-center shrink-0" data-alt="User profile avatar"
            style="background-image: url('<%=currUser.profilePic.url%>')"></div>
          <form action="/post/new" method="POST" enctype="multipart/form-data" class="flex items-center gap-2 md:gap-3 w-full">

            <input name="post[description]"
              class="flex-1 bg-white/5 rounded-xl px-3 md:px-4 py-2 md:py-2.5 text-white outline-none focus:ring-1 focus:ring-primary/50 text-xs md:text-sm"
              placeholder="What's on your mind?" required />

            <div class="flex items-center shrink-0">
              <label for="file-upload"
                class="cursor-pointer text-primary p-1.5 md:p-2 hover:bg-primary/10 rounded-full transition-colors">
                <span class="material-symbols-outlined text-xl md:text-2xl">image</span>
                <input id="file-upload" type="file" name="image" class="hidden" accept="image/*" />
              </label>

              <button type="submit" class="text-primary p-1.5 md:p-2 hover:bg-primary/10 rounded-full transition-colors">
                <span class="material-symbols-outlined text-xl md:text-2xl">upload</span>
              </button>
            </div>
          </form>
        </div>
        <!-- Social Feed Card 1 -->
        <% for (let Post of allPosts) { %>
          <article class="glass-card rounded-2xl md:rounded-xl overflow-hidden shadow-[0_8px_30px_rgb(0,0,0,0.12)] md:shadow-2xl transition-all hover:border-white/20 mb-4 flex flex-col min-h-[250px] md:min-h-0 md:block">
  
  <div class="p-4 flex items-center justify-between">
    <a href="/user/<%=Post.owner._id%>" class="flex items-center gap-3 group">
      <div class="size-11 md:size-10 rounded-full bg-cover bg-center shadow-sm" data-alt="<%=Post.owner.name%> profile image"
        style="background-image: url('<%=Post.owner.profilePic.url%>')"></div>
      <div class="flex flex-col justify-center">
        <p class="text-[15px] md:text-sm font-bold text-white group-hover:text-primary transition-colors leading-tight">
          <%=Post.owner.name%>
        </p>
        <p class="text-xs md:text-[11px] text-white/40 font-medium mt-0.5 md:mt-0">
          <%=Post.createdAt.toDateString()%> • BFGI
        </p>
      </div>
    </a>

    <% if(currentUser._id.toString() === Post.owner._id.toString()) { %>
      <div class="relative post-menu-container">
        <button class="menu-button-toggle p-2 -mr-2 hover:bg-white/10 md:hover:bg-slate-100 md:dark:hover:bg-slate-800 rounded-full transition-colors outline-none active:scale-95">
          <span class="material-symbols-outlined text-white/60 md:text-slate-400 text-2xl md:text-xl">more_vert</span>
        </button>

        <div class="hidden post-dropdown absolute right-0 mt-2 w-48 md:w-40 bg-[#1a1a1a]/95 md:bg-white md:dark:bg-slate-800 backdrop-blur-xl md:backdrop-blur-none rounded-2xl shadow-[0_10px_40px_rgba(0,0,0,0.8)] md:shadow-2xl border border-white/10 md:border-slate-100 md:dark:border-slate-700 z-50 py-1.5 md:py-2 overflow-hidden transform origin-top-right transition-all">
          <form action="/post/edit/<%=Post._id%>" method="GET" class="m-0">
            <button class="w-full text-left px-4 py-3.5 md:py-2 text-sm text-white/90 md:text-slate-700 md:dark:text-slate-200 hover:bg-white/10 md:hover:bg-slate-50 md:dark:hover:bg-slate-700 flex items-center gap-3 md:gap-2 transition-colors active:bg-white/20">
              <span class="material-symbols-outlined text-[20px] md:text-lg text-white/60 md:text-inherit">edit</span> 
              <span class="font-medium md:font-normal">Edit Post</span>
            </button>
          </form>

          <div class="h-[1px] w-full bg-white/10 md:hidden my-0.5"></div>

          <form action="/post/delete/<%=Post._id%>?_method=DELETE" method="POST" class="m-0">
            <button class="w-full text-left px-4 py-3.5 md:py-2 text-sm text-red-400 md:text-red-500 hover:bg-red-500/10 md:hover:bg-red-50 md:dark:hover:bg-red-900/20 flex items-center gap-3 md:gap-2 transition-colors active:bg-red-500/20">
              <span class="material-symbols-outlined text-[20px] md:text-lg">delete</span>
              <span class="font-medium md:font-normal">Delete Post</span>
            </button>
          </form>
        </div>
      </div>
    <% } %>
  </div>

  <div class="px-4 pb-4 md:pb-3">
    <p class="text-[15px] md:text-sm text-white/95 md:text-white/90 leading-[1.6] md:leading-relaxed break-words">
      <%=Post.description%>
    </p>
  </div>

  <% if(Post.image.url) { %>
    <div class="mx-4 mb-5 md:mb-4 rounded-2xl md:rounded-xl h-[320px] md:h-auto md:aspect-video bg-cover bg-center overflow-hidden border border-white/10 md:border-0 shadow-lg md:shadow-none"
      data-alt="Post image" style="background-image: url('<%=Post.image.url%>')"></div>
  <% } else { %>
    <div class="h-4 md:hidden"></div>
  <% } %>

  <div class="mt-auto md:mt-0 px-4 py-4 md:py-3 border-t border-white/5 flex items-center justify-between bg-white/[0.02] md:bg-transparent">
    
    <div class="flex gap-6 md:gap-4">
      
      <button class="like-btn flex items-center gap-2 md:gap-1.5 transition-all active:scale-110" data-id="<%= Post._id %>">
        <span class="material-symbols-outlined text-[26px] md:text-[20px] icon-heart <%= Post.like.includes(currentUser._id) ? 'fill text-primary' : 'text-white/50' %>">
          favorite
        </span>
        <span class="like-count text-sm md:text-xs font-semibold md:font-bold <%= Post.like.includes(currentUser._id) ? 'text-primary' : 'text-white/50' %>">
          <%= Post.like.length %>
        </span>
      </button>

      <button onclick="focusCommentInput('<%=Post._id%>')" class="flex items-center gap-2 md:gap-1.5 text-white/50 hover:text-white transition-all active:scale-110">
        <span class="material-symbols-outlined text-[26px] md:text-[20px]">chat_bubble</span>
        <span class="text-sm md:text-xs font-semibold md:font-bold">
          <%=Post.comments.length%>
        </span>
      </button>

      <button class="flex items-center gap-2 md:gap-1.5 text-white/50 hover:text-white transition-all active:scale-110">
        <span class="material-symbols-outlined text-[26px] md:text-[20px]">send</span>
      </button>

    </div>

    <a href="/post/<%=Post._id%>"
      class="bg-primary/10 md:bg-primary/20 hover:bg-primary md:hover:bg-primary/30 text-primary md:hover:text-primary hover:text-white text-sm md:text-xs font-bold px-5 py-2.5 md:px-4 md:py-1.5 rounded-xl md:rounded-lg transition-all border border-primary/20 md:border-none shadow-lg shadow-primary/0 hover:shadow-primary/20 md:shadow-none">
      <span class="md:hidden">View Post</span>
      <span class="hidden md:inline">view</span>
    </a>
  </div>

</article>
          <% } %>
          <div class="text-center mt-4 pb-24 md:pb-0" id="load-more-container">
            <button id="load-more-btn" data-page="2" class="text-primary text-xs md:text-sm font-bold hover:underline bg-transparent border-none cursor-pointer">
              See more Posts
            </button>
          </div>
      </section>
      <% } else { %>
        <%- include("../includes/post.ejs") %>
          <% } %>

            <!-- Right Sidebar: All Chats (Hidden on Mobile) -->
           <aside class="hidden md:block md:col-span-3">
    <div class="sticky top-24 max-h-[calc(100vh-8rem)] overflow-y-auto pr-2 custom-scrollbar space-y-4">
        
        <div class="glass-card rounded-xl p-5">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-white text-lg font-bold">MY LOOPSPACES</h3>
                <span class="material-symbols-outlined text-white/40 text-sm">groups</span>
            </div>

            <div class="space-y-4">
                <% if(currentUser.loopSpace.length===0 ) { %>
                    <p class="text-[11px] text-white/40 truncate">You Have'nt connect to any LoopSpace</p>
                <% }else { %>
                    <% for(let LoopSpace of currentUser.loopSpace) { %>
                        <a href="/loopSpace/<%=LoopSpace._id%>"
                            class="flex items-center gap-3 group cursor-pointer p-2 rounded-xl hover:bg-white/5 transition-all">
                            <div class="size-10 rounded-full bg-gradient-to-br from-purple-500 to-indigo-600 flex items-center justify-center text-xs font-bold text-white shrink-0">
                                10A
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-semibold text-white truncate">
                                    <%= LoopSpace.name %>
                                </p>
                                <p class="text-[10px] text-white/40 group-hover:text-white/60 transition-colors">
                                    <%= LoopSpace.members.length %> members • <%= LoopSpace.category %>
                                </p>
                            </div>
                        </a>
                    <% } }%>
            </div>
            <% if(currentUser.loopSpace.length> 3) { %>
                <button class="w-full mt-4 py-2 text-[11px] font-bold text-white/40 hover:text-white transition-colors uppercase tracking-widest">
                    View all LoopSpaces
                </button>
            <% } %>
        </div>

        <% if(currentUser.synced.length > 0) {%>
            <div class="glass-card rounded-xl p-4 h-fit">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-white text-lg font-bold">All Chats</h3>
                    <span class="size-6 bg-white/5 rounded flex items-center justify-center">
                        <span class="material-symbols-outlined text-[16px]">edit_square</span>
                    </span>
                </div>
                <% if(currentUser) { %>
                    <div class="space-y-5">
                        <% if(currentUser.synced.length==0) { %>
                            <h3>You have no connection for Chatting</h3>
                        <% } else { for(let User of currentUser.synced) { %>

                            <a href="/chat?chatId=<%=User._id%>"
                                class="rounded-xl hover:bg-white/5 flex items-center gap-3 group cursor-pointer">
                                <div class="relative">
                                    <div class="size-11 rounded-full bg-cover bg-center" data-alt="Contact profile 1"
                                        style="background-image: url('<%=User.profilePic.url%>')"></div>
                                    <% if(User.isActive) { %>
                                        <div class="absolute bottom-0 right-0 size-3.5 rounded-full border-2 border-surface-dark bg-green-500">
                                        </div>
                                    <% } else{ %>
                                        <div style="background: grey;"
                                            class="absolute bottom-0 right-0 size-3.5 rounded-full border-2 border-surface-dark">
                                        </div>
                                    <% } %>
                                </div>
                                <div class="flex-1 overflow-hidden">
                                    <p class="text-sm font-semibold text-white truncate">
                                        <%=User.name%>
                                    </p>
                                    <% if(unreadCounts[User._id]> 0) { %>
                                        <p class="text-[10px] text-green-500 font-medium truncate">
                                            <%=unreadCounts[User._id] %> New Messages
                                        </p>
                                    <% } else{ %>
                                        <p class="text-[11px] text-white/40 truncate">
                                            <%= lastMessages[User._id] %>
                                        </p>
                                    <% } %>
                                </div>

                            </a>
                        <% } %>
                    </div>
                <% }} %>
                <a href="/chat"
                    class="w-full mt-4 py-3 rounded-xl bg-primary/10 text-primary hover:bg-primary hover:text-white transition-all text-sm font-bold flex items-center justify-center gap-2">
                    <span class="material-symbols-outlined text-[20px]">forum</span>
                    Start Chatting
                </a>
            </div>
        <% } else{ %>
            <div class="glass-card rounded-2xl p-5">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-white text-lg font-bold">All Chats</h3>
                    <span class="size-6 bg-white/5 rounded flex items-center justify-center cursor-pointer hover:bg-white/10">
                        <span class="material-symbols-outlined text-[16px]">edit_square</span>
                    </span>
                </div>
                <div class="flex flex-col items-center justify-center py-3 text-center space-y-4">
                    <div class="size-16 rounded-full bg-white/5 flex items-center justify-center">
                        <span class="material-symbols-outlined text-white/20 text-3xl">chat_bubble_outline</span>
                    </div>
                    <p class="text-sm text-white/60 font-medium">No connections yet</p>
                    <a href="/user/sync-requests"
                        class="w-full py-2.5 border border-primary/40 text-primary rounded-xl text-sm font-bold hover:bg-primary/10 transition-all flex items-center justify-center gap-2">
                        <span class="material-symbols-outlined text-[18px]">person_search</span>
                        Find Peers
                    </a>
                </div>
            </div>
        <% } %>
        
    </div>
</aside>
  </main>

  <!-- Mobile Bottom Navigation (Visible only on mobile) -->
  <nav class="md:hidden fixed bottom-0 left-0 right-0 z-50 px-4 pb-4">
    <div class="glass-card rounded-2xl px-2 py-3 flex items-center justify-around shadow-2xl">
      <a href="/home" class="flex flex-col items-center gap-1 text-primary px-3 py-1">
        <span class="material-symbols-outlined fill text-xl">amp_stories</span>
        <span class="text-[10px] font-semibold">Feed</span>
      </a>
      <a href="/user/sync-requests" class="flex flex-col items-center gap-1 text-white/60 hover:text-primary transition-colors px-3 py-1 relative">
        <span class="material-symbols-outlined text-xl">person_add</span>
        <span class="text-[10px] font-medium">Requests</span>
        <% if (connectionRequestCount> 0) { %>
          <span class="absolute top-0 right-1 bg-primary text-[8px] px-1.5 py-0.5 rounded-full animate-pulse">
            <%= connectionRequestCount %>
          </span>
        <% } %>
      </a>
      <a href="/doubtBin" class="flex flex-col items-center gap-1 text-white/60 hover:text-primary transition-colors px-3 py-1">
        <span class="material-symbols-outlined text-xl">help_center</span>
        <span class="text-[10px] font-medium">DoubtBin</span>
      </a>
      <a href="/chat" class="flex flex-col items-center gap-1 text-white/60 hover:text-primary transition-colors px-3 py-1">
        <span class="material-symbols-outlined text-xl">forum</span>
        <span class="text-[10px] font-medium">Chats</span>
      </a>
    </div>
  </nav>

  <script>
    function focusCommentInput(postId) {
      // If you are on the individual post view (post.ejs)
      const mainInput = document.getElementById('main-comment-input');
      if (mainInput) {
        mainInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
        mainInput.focus();
      } else {
        // If you are on the feed (home.ejs), redirect to the post detail page
        window.location.href = `/post/${postId}#main-comment-input`;
      }
    }

    window.addEventListener("click", (e) => {
      // 1. Find the closest menu container if a menu button was clicked
      const button = e.target.closest(".menu-button-toggle");
      const allDropdowns = document.querySelectorAll(".post-dropdown");

      if (button) {
        e.stopPropagation();
        const currentDropdown = button.nextElementSibling; // The dropdown is right after the button

        // Close all other dropdowns first
        allDropdowns.forEach((menu) => {
          if (menu !== currentDropdown) menu.classList.add("hidden");
        });

        // Toggle the current one
        currentDropdown.classList.toggle("hidden");
      } else {
        // 2. If clicking anywhere else, close all open menus
        allDropdowns.forEach((menu) => menu.classList.add("hidden"));
      }
    });

    // Handle Esc key
    window.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        document.querySelectorAll(".post-dropdown").forEach((m) => m.classList.add("hidden"));
      }
    });


    document.addEventListener("click", async (e) => {
      // 1. Check if the clicked element is the like button (or inside it)
      const btn = e.target.closest(".like-btn");
      if (!btn) return;

      e.preventDefault();

      const postId = btn.dataset.id;
      const icon = btn.querySelector(".icon-heart");
      const countText = btn.querySelector(".like-count");

      try {
        // 2. Send the AJAX POST request
        const response = await fetch(`/post/${postId}/like`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            // If you use CSRF protection, add the header here
          }
        });

        const data = await response.json();

        if (data.likeCount !== undefined) {
          // 3. Update the UI based on server response
          if (data.isLiked) {
            icon.classList.add("fill", "text-primary");
            icon.classList.remove("text-white/50");
            countText.classList.add("text-primary");
            countText.classList.remove("text-white/50");
          } else {
            icon.classList.remove("fill", "text-primary");
            icon.classList.add("text-white/50");
            countText.classList.remove("text-primary");
            countText.classList.add("text-white/50");
          }

          // Update the numbers
          countText.innerText = data.likeCount;
        }
      } catch (err) {
        console.error("AJAX Like Error:", err);
      }
    });
 
    document.getElementById('load-more-btn').addEventListener('click', async (e) => {
    const btn = e.target;
    const nextPage = btn.getAttribute('data-page');
    
    // Change button text to show it's loading
    btn.innerText = "Loading...";

    try {
      // Hit the new backend route
      const response = await fetch(`/home/api/posts/more?page=${nextPage}`);
      const data = await response.json();

      if (data.success) {
        // Target the container that holds the button
        const loadMoreContainer = document.getElementById('load-more-container');

        data.posts.forEach(post => {
          // 1. Check if the current user owns this post to show the edit/delete menu
          // You need to pass the currentUser ID from EJS to a JS variable somewhere, 
          // or assume it's passed in the API response. 
          // For this example, assuming your API sends back `post.isOwner` boolean.
          // If not, you might need to compare IDs if your API returns the current user ID.
          
          // Fallback if your API doesn't send this flag:
          const currentUserId = '<%= currentUser._id %>'; 
          const isOwner = currentUserId === post.owner._id;

          // 2. Format the date (since JSON dates come as strings)
          const date = new Date(post.createdAt).toDateString();

          // 3. Build the Post HTML
          let postHTML = `
          <article class="glass-card rounded-xl overflow-hidden shadow-2xl transition-all hover:border-white/20 mb-4 md:mb-6">
            <div class="p-3 md:p-4 flex items-center justify-between">
              <a href="/user/${post.owner._id}" class="flex items-center gap-2 md:gap-3">
                <div class="size-9 md:size-10 rounded-full bg-cover bg-center" data-alt="${post.owner.name} profile image"
                  style="background-image: url('${post.owner.profilePic ? post.owner.profilePic.url : ''}')"></div>
                <div>
                  <p class="text-xs md:text-sm font-bold text-white">
                    ${post.owner.name}
                  </p>
                  <p class="text-[10px] md:text-[11px] text-white/40">
                    ${date} • BFGI
                  </p>
                </div>
              </a>
          `;

          // Add Edit/Delete menu if owner
          if (isOwner) {
            postHTML += `
              <div class="relative post-menu-container">
                <button class="menu-button-toggle p-1.5 md:p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full transition-colors outline-none">
                  <span class="material-symbols-outlined text-slate-400 text-xl md:text-2xl">more_vert</span>
                </button>
                <div class="hidden post-dropdown absolute right-0 mt-1 w-36 md:w-40 bg-white dark:bg-slate-800 rounded-xl md:rounded-2xl shadow-2xl border border-slate-100 dark:border-slate-700 z-10 py-2">
                  <form action="/post/edit/${post._id}" method="GET">
                    <button class="w-full text-left px-3 md:px-4 py-2 text-xs md:text-sm hover:bg-slate-50 dark:hover:bg-slate-700 flex items-center gap-2 transition-colors">
                      <span class="material-symbols-outlined text-base md:text-lg">edit</span> Edit Post
                    </button>
                  </form>
                  <form action="/post/delete/${post._id}?_method=DELETE" method="POST">
                    <button class="w-full text-left px-3 md:px-4 py-2 text-xs md:text-sm text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 flex items-center gap-2 transition-colors">
                      <span class="material-symbols-outlined text-base md:text-lg">delete</span> Delete Post
                    </button>
                  </form>
                </div>
              </div>
            `;
          }

          postHTML += `
            </div>
            <div class="px-3 md:px-4 pb-2 md:pb-3">
              <p class="text-xs md:text-sm text-white/90 leading-relaxed">
                ${post.description}
              </p>
            </div>
          `;

          // Add Image if it exists
          if (post.image && post.image.url) {
            postHTML += `
              <div class="mx-3 md:mx-4 mb-3 md:mb-4 rounded-lg md:rounded-xl aspect-video bg-cover bg-center overflow-hidden"
                style="background-image: url('${post.image.url}')"></div>
            `;
          }

          // Check if the current user has liked this post
          const isLiked = post.like && post.like.includes(currentUserId);
          const likeCount = post.like ? post.like.length : 0;
          const commentCount = post.comments ? post.comments.length : 0;

          // Reaction Bar
          postHTML += `
              <div class="px-3 md:px-4 py-2.5 md:py-3 border-t border-white/5 flex items-center justify-between">
                <div class="flex gap-3 md:gap-4">
                  <button class="like-btn flex items-center gap-1 md:gap-1.5 transition-all active:scale-125" data-id="${post._id}">
                    <span class="material-symbols-outlined text-[18px] md:text-[20px] icon-heart ${isLiked ? 'fill text-primary' : 'text-white/50'}">
                      favorite
                    </span>
                    <span class="like-count text-[10px] md:text-xs font-bold ${isLiked ? 'text-primary' : 'text-white/50'}">
                      ${likeCount}
                    </span>
                  </button>
                  <button onclick="focusCommentInput('${post._id}')" class="flex items-center gap-1 md:gap-1.5 text-white/50 hover:text-white transition-colors">
                    <span class="material-symbols-outlined text-[18px] md:text-[20px]">chat_bubble</span>
                    <span class="text-[10px] md:text-xs font-bold">
                      ${commentCount}
                    </span>
                  </button>
                  <button class="flex items-center gap-1 md:gap-1.5 text-white/50 hover:text-white">
                    <span class="material-symbols-outlined text-[18px] md:text-[20px]">share</span>
                    <span class="text-[10px] md:text-xs font-bold">
                      ${commentCount}
                    </span>
                  </button>
                </div>
                <a href="/post/${post._id}" class="bg-primary/20 hover:bg-primary/30 text-primary text-[10px] md:text-xs font-bold px-3 md:px-4 py-1 md:py-1.5 rounded-lg transition-colors">
                  view
                </a>
              </div>
          </article>
          `;

          // Insert the HTML right before the Load More button container
          loadMoreContainer.insertAdjacentHTML('beforebegin', postHTML);
        });

        // Update the page number for the next click
        btn.setAttribute('data-page', parseInt(nextPage) + 1);
        btn.innerText = "See more Posts";

        // If your API sends a flag indicating there are no more posts
        if (!data.hasMore) {
          loadMoreContainer.style.display = 'none';
        }

      } else {
        console.error("API returned success: false");
        btn.innerText = "See more Posts";
      }
    } catch (error) {
      console.error("Failed to load posts", error);
      btn.innerText = "See more Posts";
    }
  });
    </script>
