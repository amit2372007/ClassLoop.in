<%- include("../includes/loader.ejs") -%> 
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>ClassLoop - Join Class <%= currClass.className %></title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0&display=swap" rel="stylesheet" />
    
    <script id="tailwind-config">
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              "primary-blue": "#1e3a8a",
              "primary": "#9f1fef",
              "primary-magenta": "#701a75",
            },
            fontFamily: {
              sans: ["Inter", "sans-serif"],
            }
          },
        },
      };
    </script>
    <style>
      body { font-family: 'Inter', sans-serif; }

      .poster-wrapper {
        width: 100%;
        max-width: 440px;
        margin: 0 auto;
      }

      #poster-card {
        background: linear-gradient(135deg, #1e3a8a 0%, #701a75 50%, #4c0519 100%);
        width: 440px;
        box-sizing: border-box;
      }

      /* Scale poster down on small screens for live view only */
      @media (max-width: 479px) {
        .poster-scale-wrapper {
          transform-origin: top center;
          transform: scale(0.82);
          margin-bottom: -80px;
        }
      }
      @media (max-width: 380px) {
        .poster-scale-wrapper {
          transform: scale(0.70);
          margin-bottom: -130px;
        }
      }

      /* ── Off-screen capture poster ──
         This hidden element is what html2canvas actually renders.
         - Zero Tailwind classes on layout/text (avoids Tailwind resets)
         - No flexbox gap (use margin-right instead)
         - All px values explicit
         - Positioned way off-screen so it doesn't affect layout
      */
      #poster-capture {
        position: fixed;
        left: -9999px;
        top: 0;
        width: 440px;
        background: linear-gradient(135deg, #1e3a8a 0%, #701a75 50%, #4c0519 100%);
        border-radius: 32px;
        padding: 40px 32px;
        box-sizing: border-box;
        overflow: hidden;
        z-index: -1;
      }

      #poster-capture * {
        box-sizing: border-box;
        font-family: 'Inter', sans-serif !important;
        transform: none !important;
        -webkit-transform: none !important;
      }
    </style>
  </head>
  <body class="bg-slate-900 min-h-screen flex flex-col items-center justify-start sm:justify-center p-4 pt-6 sm:pt-4">

    <!-- ── Back Button ── -->
    <div class="poster-wrapper mb-4">
      <a
        href="/teacher?tab=Overview"
        class="inline-flex items-center gap-2 text-white/70 hover:text-white font-semibold text-sm transition-colors group"
      >
        <span class="material-symbols-outlined text-xl group-hover:-translate-x-1 transition-transform">arrow_back</span>
        Back to Overview
      </a>
    </div>

    <!-- ══════════════════════════════════════════
         LIVE DISPLAY POSTER (screen only)
         ══════════════════════════════════════════ -->
    <div class="poster-wrapper flex flex-col items-center">
      <div class="poster-scale-wrapper w-full flex flex-col items-center">
        <div id="poster-card" class="flex flex-col items-center py-10 px-8 rounded-[2rem] shadow-2xl relative overflow-hidden">

          <header class="w-full text-center mb-8">
            <div class="flex items-center justify-center gap-3 mb-5">
              <div class="w-10 h-10 bg-primary rounded-xl flex items-center justify-center text-white shadow-lg flex-shrink-0">
                <span class="material-symbols-outlined" style="font-size:24px;line-height:1;">all_inclusive</span>
              </div>
              <h1 class="text-white text-2xl font-extrabold" style="margin:0;line-height:1.2;">ClassLoop.in</h1>
            </div>
            <div>
              <h2 class="text-white text-xl font-bold" style="margin:0 0 4px;line-height:1.3;">
                <%= currSchool.name || currSchool.schoolName %>
              </h2>
              <p class="text-white/70 font-semibold text-sm" style="margin:0 0 8px;">
                Principal: <%= currSchool.principle ? (currSchool.principle.name || currSchool.principle.username) : "Admin" %>
              </p>
              <p class="text-white/90 text-sm font-medium border-t border-white/20" style="margin:0;padding-top:8px;">
                Scan the QR below to submit a join request for this class.
              </p>
            </div>
          </header>

          <main class="w-full flex flex-col items-center gap-8">
            <div class="relative" style="padding:12px;">
              <div class="absolute" style="top:0;left:0;width:28px;height:28px;border-top:3px solid rgba(255,255,255,0.5);border-left:3px solid rgba(255,255,255,0.5);border-radius:8px 0 0 0;"></div>
              <div class="absolute" style="top:0;right:0;width:28px;height:28px;border-top:3px solid rgba(255,255,255,0.5);border-right:3px solid rgba(255,255,255,0.5);border-radius:0 8px 0 0;"></div>
              <div class="absolute" style="bottom:0;left:0;width:28px;height:28px;border-bottom:3px solid rgba(255,255,255,0.5);border-left:3px solid rgba(255,255,255,0.5);border-radius:0 0 0 8px;"></div>
              <div class="absolute" style="bottom:0;right:0;width:28px;height:28px;border-bottom:3px solid rgba(255,255,255,0.5);border-right:3px solid rgba(255,255,255,0.5);border-radius:0 0 8px 0;"></div>
              <div style="width:240px;height:240px;background:#fff;border-radius:20px;box-shadow:0 10px 40px rgba(0,0,0,0.25);display:flex;align-items:center;justify-content:center;padding:8px;">
                <div style="width:100%;height:100%;border:6px solid #f1f5f9;border-radius:14px;display:flex;align-items:center;justify-content:center;background:#fff;overflow:hidden;">
                  <% if (currClass.QRCode && currClass.QRCode.url) { %>
                    <img src="<%= currClass.QRCode.url %>" alt="QR Code" crossorigin="anonymous" style="width:90%;height:90%;object-fit:contain;display:block;" />
                  <% } else { %>
                    <p style="color:#94a3b8;font-size:13px;font-weight:700;text-align:center;margin:0;">No QR Code</p>
                  <% } %>
                </div>
              </div>
            </div>

            <div style="text-align:center;width:100%;">
              <h3 class="text-white font-extrabold" style="font-size:28px;margin:0 0 4px;line-height:1.2;">Class <%= currClass.className %></h3>
              <p class="text-white/80 font-bold uppercase" style="font-size:11px;margin:0;letter-spacing:0.12em;">
                SECTION <%= currClass.section %> <%= currClass.session ? '• ' + currClass.session : '' %>
              </p>
            </div>

            <div class="w-full rounded-2xl" style="background:rgba(255,255,255,0.15);border:1px solid rgba(255,255,255,0.3);padding:16px;display:flex;align-items:center;gap:16px;">
              <img
                alt="Teacher Profile"
                style="width:56px;height:56px;border-radius:50%;object-fit:cover;border:2px solid rgba(255,255,255,0.4);background:#cbd5e1;display:block;flex-shrink:0;"
                src="<%= teacher.profilePic ? teacher.profilePic.url : 'https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_1280.png' %>"
                crossorigin="anonymous"
              />
              <div style="flex:1;min-width:0;">
                <p style="color:#fff;font-weight:700;font-size:15px;line-height:1.3;margin:0 0 2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
                  <%= teacher.name || teacher.username || "Teacher" %>
                </p>
                <p style="color:rgba(255,255,255,0.8);font-size:13px;font-weight:500;margin:0;">Class Teacher</p>
              </div>
              <span class="material-symbols-outlined" style="color:rgba(255,255,255,0.6);font-size:24px;line-height:1;flex-shrink:0;">verified</span>
            </div>
          </main>

          <footer style="margin-top:48px;width:100%;">
            <div style="display:flex;align-items:center;gap:16px;padding:0 16px;">
              <div style="height:1px;flex:1;background:rgba(255,255,255,0.2);"></div>
              <span style="font-size:10px;color:rgba(255,255,255,0.6);font-weight:700;text-transform:uppercase;letter-spacing:0.12em;white-space:nowrap;">Verified Portal</span>
              <div style="height:1px;flex:1;background:rgba(255,255,255,0.2);"></div>
            </div>
          </footer>
        </div>
      </div>

      <!-- Download Button -->
      <div class="w-full mt-6 px-2">
        <% if (currClass.QRCode && currClass.QRCode.url) { %>
          <button
            id="download-btn"
            onclick="downloadPoster('<%= currClass.className %>', '<%= currClass.section %>')"
            class="w-full py-4 bg-primary hover:bg-primary/90 rounded-2xl text-white font-bold text-lg flex justify-center items-center gap-3 transition-all shadow-xl active:scale-95"
          >
            <span class="material-symbols-outlined">download</span>
            Download Printable Poster
          </button>
        <% } %>
      </div>
    </div>


    <!-- ══════════════════════════════════════════
         HIDDEN OFF-SCREEN CAPTURE POSTER
         html2canvas renders THIS element, not the live one.
         Rules:
           - No Tailwind utility classes
           - No flexbox gap (margin-right used instead)
           - All styles inline with explicit px
           - font-family declared on every text node
         ══════════════════════════════════════════ -->
    <div id="poster-capture">

      <!-- Header -->
      <div style="text-align:center;margin-bottom:32px;">
        <!-- Logo row: no gap, use margin-right. SVG icon avoids font-loading issues in html2canvas -->
        <div style="display:flex;align-items:center;justify-content:center;margin-bottom:20px;">
          <div style="width:40px;height:40px;min-width:40px;background:#9f1fef;border-radius:12px;display:flex;align-items:center;justify-content:center;margin-right:12px;">
            <!-- all_inclusive icon as inline SVG — no font needed -->
            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 12c-2-2.5-4-4-6-4a4 4 0 0 0 0 8c2 0 4-1.5 6-4z"/>
              <path d="M12 12c2 2.5 4 4 6 4a4 4 0 0 0 0-8c-2 0-4 1.5-6 4z"/>
            </svg>
          </div>
          <span style="color:#fff;font-size:22px;font-weight:800;line-height:1.2;font-family:'Inter',sans-serif;white-space:nowrap;">ClassLoop.in</span>
        </div>
        <!-- School -->
        <div style="color:#fff;font-size:19px;font-weight:700;line-height:1.3;margin-bottom:4px;font-family:'Inter',sans-serif;">
          <%= currSchool.name || currSchool.schoolName %>
        </div>
        <!-- Principal -->
        <div style="color:rgba(255,255,255,0.7);font-size:13px;font-weight:600;margin-bottom:12px;font-family:'Inter',sans-serif;">
          Principal: <%= currSchool.principle ? (currSchool.principle.name || currSchool.principle.username) : "Admin" %>
        </div>
        <!-- Divider + subtitle -->
        <div style="border-top:1px solid rgba(255,255,255,0.2);padding-top:10px;">
          <div style="color:rgba(255,255,255,0.9);font-size:13px;font-weight:500;font-family:'Inter',sans-serif;">
            Scan the QR below to submit a join request for this class.
          </div>
        </div>
      </div>

      <!-- QR Code -->
      <div style="display:flex;justify-content:center;margin-bottom:32px;">
        <div style="position:relative;padding:12px;">
          <div style="position:absolute;top:0;left:0;width:26px;height:26px;border-top:3px solid rgba(255,255,255,0.5);border-left:3px solid rgba(255,255,255,0.5);border-radius:8px 0 0 0;"></div>
          <div style="position:absolute;top:0;right:0;width:26px;height:26px;border-top:3px solid rgba(255,255,255,0.5);border-right:3px solid rgba(255,255,255,0.5);border-radius:0 8px 0 0;"></div>
          <div style="position:absolute;bottom:0;left:0;width:26px;height:26px;border-bottom:3px solid rgba(255,255,255,0.5);border-left:3px solid rgba(255,255,255,0.5);border-radius:0 0 0 8px;"></div>
          <div style="position:absolute;bottom:0;right:0;width:26px;height:26px;border-bottom:3px solid rgba(255,255,255,0.5);border-right:3px solid rgba(255,255,255,0.5);border-radius:0 0 8px 0;"></div>
          <div style="width:240px;height:240px;background:#ffffff;border-radius:20px;padding:8px;">
            <div style="width:100%;height:100%;border:6px solid #f1f5f9;border-radius:14px;overflow:hidden;background:#ffffff;display:flex;align-items:center;justify-content:center;">
              <% if (currClass.QRCode && currClass.QRCode.url) { %>
                <img
                  src="<%= currClass.QRCode.url %>"
                  alt="QR Code"
                  crossorigin="anonymous"
                  style="width:90%;height:90%;display:block;object-fit:contain;"
                />
              <% } else { %>
                <span style="color:#94a3b8;font-size:13px;font-weight:700;font-family:'Inter',sans-serif;">No QR Code</span>
              <% } %>
            </div>
          </div>
        </div>
      </div>

      <!-- Class name + section -->
      <div style="text-align:center;margin-bottom:32px;">
        <div style="color:#ffffff;font-size:28px;font-weight:800;line-height:1.2;margin-bottom:6px;font-family:'Inter',sans-serif;">
          Class <%= currClass.className %>
        </div>
        <div style="color:rgba(255,255,255,0.8);font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:2px;font-family:'Inter',sans-serif;">
          SECTION <%= currClass.section %><%= currClass.session ? ' \u2022 ' + currClass.session : '' %>
        </div>
      </div>

      <!-- Teacher card — NO flexbox gap, NO flex:1 (causes text tilt), explicit widths -->
      <div style="background:rgba(255,255,255,0.15);border:1px solid rgba(255,255,255,0.3);border-radius:16px;padding:16px;margin-bottom:48px;">
        <div style="display:flex;align-items:center;">
          <img
            alt="Teacher Profile"
            crossorigin="anonymous"
            src="<%= teacher.profilePic ? teacher.profilePic.url : 'https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_1280.png' %>"
            style="width:56px;height:56px;min-width:56px;border-radius:50%;object-fit:cover;border:2px solid rgba(255,255,255,0.4);background:#cbd5e1;display:block;margin-right:16px;"
          />
          <!-- Fixed width = card(376px) - padding(32px) - photo(56px) - photo-margin(16px) - icon(28px) - icon-margin(16px) = 228px -->
          <div style="width:228px;margin-right:16px;overflow:hidden;">
            <div style="color:#ffffff;font-weight:700;font-size:15px;line-height:1.3;margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-family:'Inter',sans-serif;display:block;">
              <%= teacher.name || teacher.username || "Teacher" %>
            </div>
            <div style="color:rgba(255,255,255,0.8);font-size:13px;font-weight:500;font-family:'Inter',sans-serif;display:block;">
              Class Teacher
            </div>
          </div>
          <!-- verified checkmark as inline SVG — no font needed -->
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" style="flex-shrink:0;min-width:24px;">
            <path d="M9 12l2 2 4-4" stroke="rgba(255,255,255,0.6)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M12 2a10 10 0 1 0 0 20A10 10 0 0 0 12 2z" stroke="rgba(255,255,255,0.6)" stroke-width="2"/>
          </svg>
        </div>
      </div>

      <!-- Footer -->
      <div style="display:flex;align-items:center;padding:0 16px;">
        <div style="height:1px;flex:1;background:rgba(255,255,255,0.2);margin-right:16px;"></div>
        <span style="font-size:10px;color:rgba(255,255,255,0.6);font-weight:700;text-transform:uppercase;letter-spacing:2px;white-space:nowrap;font-family:'Inter',sans-serif;">Verified Portal</span>
        <div style="height:1px;flex:1;background:rgba(255,255,255,0.2);margin-left:16px;"></div>
      </div>

    </div>
    <!-- /poster-capture -->


    <script src="/js/loader.js"></script>

    <script>
      async function downloadPoster(className, section) {
        const downloadBtn = document.getElementById('download-btn');
        const captureEl   = document.getElementById('poster-capture');

        const originalHTML = downloadBtn.innerHTML;
        downloadBtn.innerHTML = '<span class="material-symbols-outlined" style="display:inline-block;animation:cl-spin 1s linear infinite;vertical-align:middle;">sync</span>&nbsp;Generating...';
        downloadBtn.disabled = true;

        try {
          // Make sure all fonts are ready
          await document.fonts.ready;

          // Extra wait to let Material Symbols icon font render in off-screen element
          await new Promise(r => setTimeout(r, 900));

          const captureHeight = captureEl.scrollHeight;

          const canvas = await html2canvas(captureEl, {
            scale          : 3,
            useCORS        : true,
            allowTaint     : true,
            backgroundColor: null,
            logging        : false,
            width          : 440,
            height         : captureHeight,
            scrollX        : 9999,   // offset matches the left:-9999px
            scrollY        : 0,
            onclone: (clonedDoc) => {
              const el = clonedDoc.getElementById('poster-capture');

              // Move clone into normal flow so html2canvas sees it correctly
              el.style.position  = 'static';
              el.style.left      = '0';
              el.style.top       = '0';
              el.style.zIndex    = '1';
              el.style.transform = 'none';

              // Ensure every descendant has no transform and explicit font
              clonedDoc.querySelectorAll('#poster-capture *').forEach(node => {
                node.style.transform       = 'none';
                node.style.webkitTransform = 'none';
              });
            }
          });

          const image = canvas.toDataURL('image/png', 1.0);
          const link  = document.createElement('a');
          link.href     = image;
          link.download = `ClassLoop-Poster-${className}-${section}.png`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);

        } catch (err) {
          console.error('Poster generation failed:', err);
          alert('Failed to generate poster. Please make sure your browser allows downloads.');
        } finally {
          downloadBtn.innerHTML = originalHTML;
          downloadBtn.disabled  = false;
        }
      }

      // Spin keyframe for loading icon
      const s = document.createElement('style');
      s.textContent = '@keyframes cl-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }';
      document.head.appendChild(s);
    </script>
  </body>
</html>
