<% layout("/layout/boilerplate.ejs") -%>

    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }

        .hero-gradient {
            background: linear-gradient(135deg, #5248e5 0%, #3b34a9 100%);
        }
    </style>




    <body class="bg-background-light dark:bg-background-dark font-display antialiased">
        <div class="flex min-h-screen w-full flex-col lg:flex-row">
            <!-- Left Side: Visual Hero Section -->
            <div class="hero-gradient relative hidden w-full items-center justify-center p-12 lg:flex lg:w-1/2">
                <div class="absolute inset-0 opacity-20" data-alt="Subtle geometric cube pattern background"
                    style='background-image: url("https://ik.imagekit.io/xcrdwi6be/classLoop_icons/undraw_authentication_1evl.svg");'>
                </div>
                <div class="relative z-10 flex flex-col items-center gap-10 text-center text-white">
                    <!-- 3D Academic Illustration Placeholder -->
                    <div
                        class="group relative flex h-64 w-64 items-center justify-center rounded-full bg-white/10 backdrop-blur-md">
                        <div class="absolute h-full w-full animate-pulse rounded-full bg-white/5"></div>
                        <div class="absolute inset-0 bg-center bg-no-repeat bg-contain transition-all scale-105" 
         style='background-image: url("https://ik.imagekit.io/xcrdwi6be/classLoop_icons/undraw_forgot-password_nttj.svg");'>
    </div>
                    </div>
                    <div class="max-w-md">
                        <h1 class="mb-4 text-4xl font-black tracking-tight lg:text-5xl">
                            Recover Your Account
                        </h1>
                        <p class="text-lg font-medium text-white/80">
                            Don't worry, it happens to the best of us. Let's get you back to your classes.
                        </p>
                    </div>
                </div>
            </div>
            <!-- Right Side: Form Section -->
            <div class="flex w-full flex-col bg-white dark:bg-background-dark lg:w-1/2">
                <!-- Top Navigation Bar -->
                <header class="flex items-center justify-between px-4 py-5 lg:px-8">

                    <a class="group flex items-center gap-2 text-sm font-semibold text-primary transition-colors hover:text-primary/80"
                        href="/user/login">
                        <span
                            class="material-symbols-outlined !text-xl transition-transform group-hover:-translate-x-1">arrow_back</span>
                        Back to Login
                    </a>
                </header>
                <!-- Forgot Password Form Container -->
                <main class="flex flex-1 flex-col justify-center px-6 py-12 lg:px-24">
    <div class="mx-auto w-full max-w-md">
        <div class="mb-10">
            <h1 id="form-title" class="mb-2 text-3xl font-bold tracking-tight text-[#121117] dark:text-white lg:text-4xl">
                Reset Password
            </h1>
            <p id="form-desc" class="text-base text-[#666487] dark:text-gray-400">
                Enter your details to receive a verification OTP.
            </p>
        </div>

        <form id="resetForm" class="space-y-6">
            <div id="phone-container" class="flex flex-col gap-2">
                <label class="text-sm font-semibold text-[#121117]">Registered Mobile Number</label>
                <div class="relative group flex items-center gap-2">
                    <div class="relative flex-1">
                        <span class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-[#666487]">phone</span>
                        <input class="h-14 w-full rounded-xl border border-[#dcdce5] pl-12 pr-4" id="phone" name="phone" placeholder="81020XXXX" type="tel" maxlength="10">
                    </div>
                    <button type="button" id="otp-btn" onclick="handleSendOtp()" class="h-14 px-4 bg-primary/10 text-primary border border-primary/20 font-semibold rounded-xl">
                        Get OTP
                    </button>
                </div>
            </div>

            <div id="otp-section" class="flex flex-col gap-2 hidden">
                <label class="text-sm font-semibold text-[#121117]">Enter 6-Digit OTP</label>
                <div class="relative group">
                    <span class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-[#666487]">lock_open</span>
                    <input class="h-14 w-full rounded-xl border border-[#dcdce5] pl-12 text-base tracking-[0.5em] font-bold" id="otp" placeholder="XXXXXX" maxlength="6">
                </div>
                <button type="button" onclick="handleVerifyOtp()" class="w-full h-12 mt-2 bg-primary text-white rounded-xl font-bold">Verify OTP</button>
            </div>

            <div id="password-section" class="flex flex-col gap-4 hidden animate-in fade-in slide-in-from-bottom-4">
                <div class="flex flex-col gap-2">
                    <label class="text-sm font-semibold text-[#121117]">New Password</label>
                    <input type="password" id="newPassword" class="h-14 w-full rounded-xl border border-[#dcdce5] px-4" placeholder="••••••••">
                </div>
                <div class="flex flex-col gap-2">
                    <label class="text-sm font-semibold text-[#121117]">Confirm New Password</label>
                    <input type="password" id="confirmPassword" class="h-14 w-full rounded-xl border border-[#dcdce5] px-4" placeholder="••••••••">
                </div>
                <button type="submit" class="h-14 w-full bg-primary text-white rounded-xl font-bold">Update Password</button>
            </div>
        </form>
    </div>
</main>
            <!-- Mobile Footer Only -->
            <footer class="p-6 text-center lg:hidden">
                <p class="text-xs text-gray-400">© 2024 ClassLoop.in. All rights reserved.</p>
            </footer>
        </div>
        </div>
    </body>


    <script>
    // 1. Send OTP logic
    async function handleSendOtp() {
        const phone = document.getElementById('phone').value;
        if (phone.length !== 10) return alert("Enter valid phone number");

        const res = await fetch('/user/request-reset-otp', { // Point to your backend route
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ phone })
        });

        const data = await res.json();
        if (data.success) {
            document.getElementById('otp-section').classList.remove('hidden');
            document.getElementById('otp-btn').innerText = "Resend";
            alert("OTP Sent!");
        } else {
            alert(data.message);
        }
    }

    // 2. Verify OTP logic
    async function handleVerifyOtp() {
        const otp = document.getElementById('otp').value;
        const res = await fetch('/user/verify-reset-otp', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ otp })
        });

        const data = await res.json();
        if (data.success) {
            // Hide previous steps and show password fields
            document.getElementById('phone-container').classList.add('hidden');
            document.getElementById('otp-section').classList.add('hidden');
            document.getElementById('password-section').classList.remove('hidden');
            
            document.getElementById('form-title').innerText = "Create New Password";
            document.getElementById('form-desc').innerText = "Almost there! Set a strong password for your ClassLoop account.";
        } else {
            alert("Invalid OTP");
        }
    }

    // 3. Final Form Submission
    document.getElementById('resetForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const password = document.getElementById('newPassword').value;
        const confirm = document.getElementById('confirmPassword').value;

        if (password !== confirm) return alert("Passwords do not match!");

        const res = await fetch('/user/update-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ password })
        });

        const data = await res.json();
        if (data.success) {
            alert("Password updated! Redirecting to login...");
            window.location.href = "/user/login";
        }
    });
</script>