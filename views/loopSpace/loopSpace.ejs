<%- include("../includes/loader.ejs") -%> 
<% layout("/layout/boilerplate.ejs") -%>

    <head>
        <meta charset="utf-8" />
        <meta content="width=device-width, initial-scale=1.0" name="viewport" />
        <title>LoopSpace Community Dashboard</title>

        <script id="tailwind-config">
            tailwind.config = {
                darkMode: "class",
                theme: {
                    extend: {
                        colors: {
                            "primary": "#5248e5",
                            "background-light": "#f6f6f8",
                            "background-dark": "#0f0e1a",
                            "slate-card": "#1c1b2e",
                            "accent-emerald": "#10b981",
                            "accent-amber": "#f59e0b",
                        },
                        fontFamily: {
                            "display": ["Inter", "sans-serif"]
                        },
                        borderRadius: {
                            "DEFAULT": "0.25rem",
                            "lg": "0.5rem",
                            "xl": "0.75rem",
                            "full": "9999px"
                        },
                    },
                },
            }
        </script>
        <style>
            .glass {
                background: rgba(28, 27, 46, 0.7);
                backdrop-filter: blur(12px);
                border: 1px solid rgba(255, 255, 255, 0.05);
            }

            .material-symbols-outlined {
                font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
            }

            .active-nav {
                background: rgba(82, 72, 229, 0.15);
                border-left: 3px solid #5248e5;
            }

            .custom-scrollbar::-webkit-scrollbar {
                width: 6px;
            }
            .custom-scrollbar::-webkit-scrollbar-track {
                background: transparent;
            }
            .custom-scrollbar::-webkit-scrollbar-thumb {
                background: rgba(255, 255, 255, 0.1);
                border-radius: 10px;
            }

            /* Mobile sidebar animations */
            @keyframes slideIn {
                from {
                    transform: translateX(-100%);
                }
                to {
                    transform: translateX(0);
                }
            }

            .sidebar-open {
                animation: slideIn 0.3s ease-out;
            }

            /* Active tab mobile styling */
            .mobile-nav-active {
                background: linear-gradient(135deg, #5248e5 0%, #6366f1 100%);
                color: white;
                box-shadow: 0 4px 12px rgba(82, 72, 229, 0.4);
            }

            .mobile-nav-active .material-symbols-outlined {
                font-variation-settings: 'FILL' 1, 'wght' 600;
            }
        </style>
    </head>


    <body>

        <%# MOBILE HAMBURGER BUTTON — fixed top-left %>
        <button 
            id="mobile-menu-btn"
            onclick="toggleMobileSidebar()"
            class="lg:hidden fixed top-4 left-4 z-50 w-12 h-12 glass rounded-xl shadow-lg flex items-center justify-center hover:bg-white/10 transition-all active:scale-95">
            <span class="material-symbols-outlined text-2xl text-white" id="menu-icon">menu</span>
        </button>

        <%# MOBILE SIDEBAR — slide from left %>
        <aside
            id="mobile-sidebar"
            class="lg:hidden fixed inset-y-0 left-0 w-80 glass z-40 transform -translate-x-full transition-transform duration-300 flex flex-col shadow-2xl overflow-y-auto custom-scrollbar">
            
            <div class="p-5 flex items-center justify-between border-b border-white/10">
                <div>
                    <h1 class="text-base font-bold text-white leading-none">LoopSpace</h1>
                    <p class="text-[10px] text-slate-400 mt-1 uppercase tracking-wider font-semibold">Community Hub</p>
                </div>
                <button onclick="closeMobileSidebar()" class="p-2 hover:bg-white/10 rounded-lg transition-colors">
                    <span class="material-symbols-outlined text-slate-400">close</span>
                </button>
            </div>

            <nav class="flex-1 px-3 py-4 space-y-1">
                <p class="px-3 text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2">Main Menu</p>

                <a onclick="closeMobileSidebar()" class="flex items-center gap-3 px-3 py-3 rounded-xl transition-all <%= activeTab === 'Feed' ? 'mobile-nav-active' : 'hover:bg-white/5 text-slate-400 font-medium' %>"
                    href="?tab=Feed">
                    <span class="material-symbols-outlined text-[22px]">dynamic_feed</span>
                    <span class="text-sm font-semibold">Feed</span>
                </a>

                <a onclick="closeMobileSidebar()" class="flex items-center gap-3 px-3 py-3 rounded-xl transition-all <%= activeTab === 'loopSpaceChats' ? 'mobile-nav-active' : 'hover:bg-white/5 text-slate-400 font-medium' %>"
                    href="?tab=loopSpaceChats">
                    <span class="material-symbols-outlined text-[22px]">chat_bubble_outline</span>
                    <span class="text-sm font-semibold">
                        <%= loopSpace.class.className %>-<%= loopSpace.class.section %> Chats
                    </span>
                </a>

                <a onclick="closeMobileSidebar()" class="flex items-center gap-3 px-3 py-3 rounded-xl transition-all <%= activeTab === 'Application' ? 'mobile-nav-active' : 'hover:bg-white/5 text-slate-400 font-medium' %>"
                    href="?tab=Application">
                    <span class="material-symbols-outlined text-[22px]">campaign</span>
                    <span class="text-sm font-semibold">Application</span>
                </a>

                <a onclick="closeMobileSidebar()" class="flex items-center gap-3 px-3 py-3 rounded-xl transition-all <%= activeTab === 'Polls' ? 'mobile-nav-active' : 'hover:bg-white/5 text-slate-400 font-medium' %>"
                    href="?tab=Polls">
                    <span class="material-symbols-outlined text-[22px]">poll</span>
                    <span class="text-sm font-semibold">Polls</span>
                </a>

                <a onclick="closeMobileSidebar()" class="flex items-center gap-3 px-3 py-3 rounded-xl transition-all <%= activeTab === 'Resources' ? 'mobile-nav-active' : 'hover:bg-white/5 text-slate-400 font-medium' %>"
                    href="?tab=Resources">
                    <span class="material-symbols-outlined text-[22px]">folder_open</span>
                    <span class="text-sm font-semibold">Shared Resources</span>
                </a>
            </nav>
        </aside>

        <%# BACKDROP — appears when mobile sidebar is open %>
        <div 
            id="mobile-backdrop"
            onclick="closeMobileSidebar()"
            class="lg:hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-30 hidden transition-opacity duration-300"></div>

        <div class="max-w-[1600px] mx-auto flex gap-4 lg:gap-6 px-3 py-3 lg:pl-3 pl-16">
            <!-- Desktop Left Sidebar Navigation -->
            <aside class="hidden lg:flex w-80 flex-col gap-8 shrink-0 sticky top-3 h-[calc(100vh-24px)] overflow-y-auto custom-scrollbar">
                <nav class="flex flex-col gap-1">
                    <p class="px-4 text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2">Main Menu</p>

                    <a class="flex items-center gap-3 px-4 py-2.5 rounded-lg transition-colors <%= activeTab === 'Feed' ? 'active-nav text-primary font-bold' : 'hover:bg-white/5 text-slate-400 font-medium' %>"
                        href="?tab=Feed">
                        <span class="material-symbols-outlined text-[20px]">dynamic_feed</span>
                        <span class="text-sm">Feed</span>
                    </a>

                    <a class="flex items-center gap-3 px-4 py-2.5 rounded-lg transition-colors <%= activeTab === 'loopSpaceChats' ? 'active-nav text-primary font-bold' : 'hover:bg-white/5 text-slate-400 font-medium' %>"
                        href="?tab=loopSpaceChats">
                        <span class="material-symbols-outlined text-[20px]">chat_bubble_outline</span>
                        <span class="text-sm">
                            <%= loopSpace.class.className %>-<%= loopSpace.class.section %> Chats
                        </span>
                    </a>

                    <a class="flex items-center gap-3 px-4 py-2.5 rounded-lg transition-colors <%= activeTab === 'Application' ? 'active-nav text-primary font-bold' : 'hover:bg-white/5 text-slate-400 font-medium' %>"
                        href="?tab=Application">
                        <span class="material-symbols-outlined text-[20px]">campaign</span>
                        <span class="text-sm">Application</span>
                    </a>

                    <a class="flex items-center gap-3 px-4 py-2.5 rounded-lg transition-colors <%= activeTab === 'Polls' ? 'active-nav text-primary font-bold' : 'hover:bg-white/5 text-slate-400 font-medium' %>"
                        href="?tab=Polls">
                        <span class="material-symbols-outlined text-[20px]">poll</span>
                        <span class="text-sm">Polls</span>
                    </a>

                    <a class="flex items-center gap-3 px-4 py-2.5 rounded-lg transition-colors <%= activeTab === 'Resources' ? 'active-nav text-primary font-bold' : 'hover:bg-white/5 text-slate-400 font-medium' %>"
                        href="?tab=Resources">
                        <span class="material-symbols-outlined text-[20px]">folder_open</span>
                        <span class="text-sm">Shared Resources</span>
                    </a>
                </nav>

            </aside>


            <!-- Center Feed -->
            <% if (activeTab==="Feed" ) { %>
                <main class="flex-1 max-w-3xl space-y-4 md:space-y-6">
                    <%- include("../includes/loopSpace/Feed.ejs") %>
                </main>
                <aside class="hidden lg:block w-80 space-y-6 shrink-0">
                    <!-- DoubtBin Widget -->
                     <% if(classDoubts.length>0){ %>
                    <div class="glass rounded-xl p-5">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-sm text-white font-bold flex items-center gap-2">
                                <span class="material-symbols-outlined text-primary">psychology_alt</span>
                                DoubtBin
                            </h3>
                            <button class="text-xs text-primary font-bold hover:underline">View All</button>
                        </div>
                        <div class="space-y-3">
                            <% for(let doubt of classDoubts) { 
                                if(!doubt.isResolved){ %>
                            <div class="p-3 rounded-lg bg-white/5 border border-white/5 group relative overflow-hidden">
                                <div class="flex justify-between items-start mb-1">
                                    <p class="text-xs text-slate-300 font-medium leading-tight"><%=doubt.title%></p>
                                    <span
                                        class="material-symbols-outlined text-accent-emerald text-lg">check_circle</span>
                                </div>
                                <p class="text-[10px] text-accent-emerald font-bold">Posted by Mr. <%=doubt.author.name%></p>
                            </div>
                            <% }} %>
                            
                        </div>
                        <button
                            class="w-full mt-4 py-2 border border-dashed border-white/10 rounded-lg text-xs text-slate-500 hover:border-primary/50 hover:text-primary transition-all">
                            + Post a Doubt
                        </button>
                    </div>
                    <% } %>
                    <!-- Poll Widget -->
                    <% if(!currUser) { %>
                    <div class="glass rounded-xl p-5">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-sm text-white font-bold flex items-center gap-2">
                                <span class="material-symbols-outlined text-primary">bar_chart</span>
                                Live Poll
                            </h3>
                            <span class="flex h-2 w-2 rounded-full bg-red-500 animate-pulse"></span>
                        </div>
                        <p class="text-xs font-semibold mb-4 text-slate-200">Best time for extra Math class?</p>
                        <div class="space-y-4">
                            <div>
                                <div class="flex justify-between text-[10px] mb-1 font-medium">
                                    <span class="text-white">4 PM - 5 PM</span>
                                    <span class="text-primary">45%</span>
                                </div>
                                <div class="w-full bg-white/5 rounded-full h-2 overflow-hidden">
                                    <div class="bg-primary h-full rounded-full" style="width: 45%"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between text-[10px] mb-1 font-medium">
                                    <span class="text-white">6 PM - 7 PM</span>
                                    <span>30%</span>
                                </div>
                                <div class="w-full bg-white/5 rounded-full h-2 overflow-hidden">
                                    <div class="bg-white/10 h-full rounded-full" style="width: 30%"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between text-[10px] mb-1 font-medium">
                                    <span class="text-white">8 PM - 9 PM</span>
                                    <span>25%</span>
                                </div>
                                <div class="w-full bg-white/5 rounded-full h-2 overflow-hidden">
                                    <div class="bg-white/10 h-full rounded-full" style="width: 25%"></div>
                                </div>
                            </div>
                        </div>
                        <p class="text-[10px] text-center text-slate-500 mt-4">18 votes casted • Ending in 3h</p>
                    </div>
                    <%}%>
                    
                </aside>

                <% } else if(activeTab==="loopSpaceChats" ) { %>
                    <div
                        class="flex w-full h-[85vh] lg:h-[90vh] overflow-hidden rounded-xl lg:rounded-2xl border border-white/5 bg-background-dark/20 mx-auto">
                        <%- include("../includes/loopSpace/loopSpaceChats.ejs") %>
                    </div>
                    <% } else if(activeTab === 'Resources') {%>
                        <main class="flex-1">
                            <%- include("../includes/loopSpace/sharedResources.ejs") %>
                        </main>
                   <% } else if(activeTab === 'Application') {  %>
                        <main class="flex-1">
                            <%- include("../includes/loopSpace/application.ejs") %>
                        </main>
                    <% } %>
        </div>

        <script>
            function toggleMobileSidebar() {
                const sidebar = document.getElementById('mobile-sidebar');
                const backdrop = document.getElementById('mobile-backdrop');
                const menuIcon = document.getElementById('menu-icon');
                const menuBtn = document.getElementById('mobile-menu-btn');
                
                const isOpen = !sidebar.classList.contains('-translate-x-full');
                
                if (isOpen) {
                    // Close
                    sidebar.classList.add('-translate-x-full');
                    backdrop.classList.add('hidden');
                    menuIcon.textContent = 'menu';
                } else {
                    // Open
                    sidebar.classList.remove('-translate-x-full');
                    sidebar.classList.add('sidebar-open');
                    backdrop.classList.remove('hidden');
                    menuIcon.textContent = 'close';
                }
            }

            function closeMobileSidebar() {
                const sidebar = document.getElementById('mobile-sidebar');
                const backdrop = document.getElementById('mobile-backdrop');
                const menuIcon = document.getElementById('menu-icon');
                
                sidebar.classList.add('-translate-x-full');
                backdrop.classList.add('hidden');
                menuIcon.textContent = 'menu';
            }

            // Close sidebar on escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeMobileSidebar();
                }
            });
        </script>

        <script src="/js/loader.js"></script>
    </body>
