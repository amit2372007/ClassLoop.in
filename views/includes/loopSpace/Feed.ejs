<div class="flex items-center gap-2 p-1.5 bg-slate-100 dark:bg-white/5 rounded-2xl w-fit mb-8 border border-white/5">
    <button onclick="filterFeed('all')" 
        class="filter-btn active px-6 py-2 rounded-xl text-sm font-bold transition-all bg-primary text-white shadow-lg shadow-primary/20">
        All Feed
    </button>
    <button onclick="filterFeed('Assignment')" 
        class="filter-btn px-6 py-2 rounded-xl text-sm font-bold text-slate-500 hover:text-primary dark:hover:text-white transition-all">
        Assignments
    </button>
    <button onclick="filterFeed('Notice')" 
        class="filter-btn px-6 py-2 rounded-xl text-sm font-bold text-slate-500 hover:text-primary dark:hover:text-white transition-all">
        Notices
    </button>
    <button onclick="filterFeed('Form')" 
        class="filter-btn px-6 py-2 rounded-xl text-sm font-bold text-slate-500 hover:text-primary dark:hover:text-white transition-all">
        Forms
    </button>
</div>


<div class="space-y-6" id="feed-container">
    <% for(let Feed of loopSpace.feed) { %>
        
        <% if(Feed.itemType === "Notice" && Feed.itemRef) { %>
            <% let notice = Feed.itemRef; %>
            <div class="feed-item glass rounded-xl p-5 border-l-4 border-blue-500 hover:border-white/20 transition-all" data-category="Notice">
                <div class="flex justify-between items-start mb-4">
                    <div class="flex items-center gap-3">
                        <img class="w-10 h-10 rounded-full object-cover border border-white/10"
                            src="<%= loopSpace.admin.profilePic.url %>" />
                        <div>
                            <h4 class="text-sm text-white font-bold"><%= loopSpace.admin.name %></h4>
                            <p class="text-[10px] text-slate-500">
                                <%= formatDistanceToNow(notice.createdAt) %> ago • Notice
                            </p>
                        </div>
                    </div>
                    <span class="bg-blue-500/10 text-blue-400 text-[10px] font-bold uppercase px-2 py-1 rounded">Important</span>
                </div>
                <h3 class="text-base text-white font-semibold mb-2"><%= notice.title %></h3>
                <p class="text-sm text-slate-400 leading-relaxed mb-4"><%= notice.content %></p>
            </div>
        <% } %>

        <% if(Feed.itemType === "Assignment" && Feed.itemRef) { %>
            <% let assignment = Feed.itemRef; %>
            <div class="feed-item glass rounded-xl p-5 border-2 border-accent-amber/30 hover:shadow-xl hover:shadow-accent-amber/5 transition-all" data-category="Assignment">
                <div class="flex justify-between items-start mb-4">
                    <div class="flex items-center gap-3">
                        <img class="w-10 h-10 rounded-full object-cover border border-white/10"
                            src="<%= loopSpace.admin.profilePic.url %>" />
                        <div>
                            <h4 class="text-sm font-bold text-white"><%= loopSpace.admin.name %></h4>
                            <p class="text-[10px] text-slate-500">
                                <%= formatDistanceToNow(assignment.createdAt) %> ago • Assignment
                            </p>
                        </div>
                    </div>
                    <div class="flex flex-col items-end">
                        <span class="text-accent-amber text-[10px] font-bold uppercase">
                            Due <%= assignment.dueDate.toLocaleDateString('en-IN', { weekday: 'long' }) %>
                        </span>
                    </div>
                </div>
                <h3 class="text-base font-semibold text-white mb-2"><%= assignment.title %></h3>
                <p class="text-sm text-slate-400 leading-relaxed mb-4 line-clamp-2"><%= assignment.description %></p>
                
                <div class="flex items-center justify-between pt-4 border-t border-white/5">
    <span class="text-[10px] text-slate-500 font-medium">
        <%= assignment.submissions ? assignment.submissions.length : 0 %> Submissions
    </span>

    <% 
        // Check if the current student has already submitted
        const hasSubmitted = assignment.submissions.some(sub => sub.student.toString() === currUser._id.toString());
    %>

    <% if (hasSubmitted) { %>
        <a href="<%= assignment.attachments %>" target="_blank"
            class="flex items-center gap-2 text-xs font-bold text-accent-amber bg-accent-amber/10 px-4 py-1.5 rounded-lg border border-accent-amber/20 hover:bg-accent-amber hover:text-white transition-all">
            <span class="material-symbols-outlined text-sm">file_open</span> 
             View Assignment
        </a>

        <div class="flex items-center gap-2 text-xs font-bold text-emerald-500 bg-emerald-500/10 px-4 py-1.5 rounded-lg border border-emerald-500/20">
            <span class="material-symbols-outlined text-sm">check_circle</span>
            Assignment Submitted
        </div>
    <% } else { %>
        <form id="uploadForm_<%= assignment._id %>" action="/loopSpace/assignments/<%= assignment._id %>/upload" method="POST" enctype="multipart/form-data" class="hidden">
            <input type="file" name="assignmentFile" id="fileInput_<%= assignment._id %>" 
                   onchange="confirmAndSubmit(this, '<%= assignment._id %>')" required>
        </form>

        <a  href="<%= assignment.attachments %>" target="_blank"
            class="flex items-center gap-2 text-xs font-bold text-accent-amber bg-accent-amber/10 px-4 py-1.5 rounded-lg border border-accent-amber/20 hover:bg-accent-amber hover:text-white transition-all">
            <span class="material-symbols-outlined text-sm">file_open</span> 
             View Assignment
        </a>

        <button onclick="document.getElementById('fileInput_<%= assignment._id %>').click()"
            class="flex items-center gap-2 text-xs font-bold text-accent-amber bg-accent-amber/10 px-4 py-1.5 rounded-lg border border-accent-amber/20 hover:bg-accent-amber hover:text-white transition-all">
            <span class="material-symbols-outlined text-sm">upload_file</span> 
            Upload Assignment
        </button>
    <% } %>
</div>
            </div>
        <% } %>

        <% if(Feed.itemType === "Form" && Feed.itemRef) { %>
            <% let form = Feed.itemRef; %>
            <div class="feed-item glass rounded-xl p-5 hover:bg-white/[0.03] transition-all" data-category="Form">
                <div class="flex justify-between items-start mb-4">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg bg-indigo-500/20 flex items-center justify-center">
                            <span class="material-symbols-outlined text-indigo-400">description</span>
                        </div>
                        <div>
                            <h4 class="text-sm text-white font-bold"><%= loopSpace.admin.name %></h4>
                            <p class="text-[10px] text-slate-500">
                                <%= formatDistanceToNow(form.createdAt) %> ago • Form
                            </p>
                        </div>
                    </div>
                </div>
                <h3 class="text-base text-white font-semibold mb-2"><%= form.title %></h3>
                <p class="text-sm text-slate-400 leading-relaxed mb-6"><%= form.description %></p>
                
                <% if (submittedFormIds.includes(Feed.itemRef._id.toString())) { %>
                    <div class="w-full py-2.5 bg-emerald-500/10 border border-emerald-500/20 text-emerald-500 rounded-lg text-sm font-bold flex items-center justify-center gap-2">
                        <span class="material-symbols-outlined text-sm">check_circle</span>
                        Response Submitted
                    </div>
                <% } else { %>
                    <form action="/loopSpace/submit-form/<%= Feed.itemRef._id %>" method="GET">
                        <button class="w-full bg-primary hover:bg-primary/90 text-white font-bold py-2.5 rounded-lg transition-all text-sm flex items-center justify-center gap-2">
                            <span class="material-symbols-outlined text-sm">edit_note</span>
                            Fill Form
                        </button>
                    </form>
                <% } %>
            </div>
        <% } %>

    <% } %> </div>


    <script>
        function confirmAndSubmit(input, assignmentId) {
        if (input.files && input.files[0]) {
            const fileName = input.files[0].name;
            // Native popup to confirm submission
            const proceed = confirm(`Are you sure you want to submit "${fileName}"?`);
            
            if (proceed) {
                document.getElementById(`uploadForm_${assignmentId}`).submit();
            } else {
                input.value = ""; // Clear selection if cancelled
            }
        }
    }



    function filterFeed(category) {
    const items = document.querySelectorAll('.feed-item');
    const buttons = document.querySelectorAll('.filter-btn');

    // 1. Update Button States
    buttons.forEach(btn => {
        btn.classList.remove('bg-primary', 'text-white', 'shadow-lg', 'shadow-primary/20', 'active');
        btn.classList.add('text-slate-500');
    });
    event.currentTarget.classList.add('bg-primary', 'text-white', 'shadow-lg', 'shadow-primary/20', 'active');
    event.currentTarget.classList.remove('text-slate-500');

    // 2. Filter Content
    items.forEach(item => {
        if (category === 'all' || item.getAttribute('data-category') === category) {
            item.style.display = 'block';
            // Optional: Add a fade-in animation
            item.classList.add('animate-in', 'fade-in', 'duration-300');
        } else {
            item.style.display = 'none';
        }
    });
}

function confirmAndSubmit(input, assignmentId) {
    if (input.files && input.files[0]) {
        const fileName = input.files[0].name;
        const proceed = confirm(`Are you sure you want to submit "${fileName}"?`);
        if (proceed) {
            document.getElementById(`uploadForm_${assignmentId}`).submit();
        } else {
            input.value = "";
        }
    }
}
    </script>